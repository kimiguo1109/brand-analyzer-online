# 故障排除指南

## 问题背景

在Vercel等serverless环境中，原本的文件系统存储方案会导致任务文件在函数执行完成后丢失，出现"分析任务已过期或被清理"的错误。

## 已实施的解决方案

### 1. 内存存储改进
- **问题原因**: 临时文件在serverless环境中会被自动清理
- **解决方案**: 使用全局内存存储（`global.tasks`）代替文件系统存储
- **优势**: 
  - 任务数据在函数生命周期内持久保存
  - 无需文件系统访问权限
  - 更快的读写性能

### 2. 模拟分析引擎
由于真实AI分析可能导致超时，我们实现了智能模拟分析：
- 基于创作者信息进行规则分析
- 特别检测Old Spice品牌相关账号
- 生成合理的统计分布

### 3. 改进的错误处理
- 更清晰的错误提示信息
- 一键重新开始分析功能
- 详细的问题说明和解决建议

## 技术实现细节

### 内存存储结构
```javascript
global.tasks = new Map();
// 存储格式: taskId -> taskObject
```

### 任务对象结构
```javascript
{
  id: "uuid",
  status: "processing|completed|error",
  filename: "原始文件名",
  fileType: ".csv|.json", 
  createdAt: "ISO时间戳",
  lastUpdated: "ISO时间戳",
  logs: ["日志消息数组"],
  progress: 0-100,
  results: {
    total_processed: 数字,
    brand_related_count: 数字,
    detailed_results: [分析结果数组]
  },
  processedCount: 数字,
  totalCount: 数字
}
```

## CSV文件支持

应用现在支持处理TikTok CSV导出文件，包含以下字段：
- `user_unique_id`: 创作者ID
- `user_nickname`: 创作者昵称  
- `follower_count`: 粉丝数量
- `video_link`: 视频链接

## 使用说明

### 1. 文件上传
- 支持JSON和CSV格式
- 文件大小限制：50MB
- 自动解析创作者信息

### 2. 分析过程
- 实时显示进度和日志
- 模拟智能分析算法
- 自动生成统计报告

### 3. 结果下载
- 品牌相关创作者CSV
- 非品牌创作者CSV
- 包含分析置信度分数

## 监控和调试

### 健康检查
访问 `/api/health` 获取系统状态：
```json
{
  "status": "healthy",
  "system": {
    "active_task_files": 3,
    "temp_directory": "ok"
  }
}
```

### 日志查看
- 控制台显示实时处理日志
- 支持错误追踪和调试

## 限制说明

### 内存存储限制
- 任务数据在服务器重启后会丢失
- 内存使用量与并发任务数成正比
- 建议及时下载分析结果

### 性能考虑
- 大文件处理可能需要更长时间
- 并发分析任务有数量限制
- 建议分批处理大量数据

## 最佳实践

1. **及时下载**: 分析完成后立即下载所需文件
2. **分批处理**: 对于大量数据，建议分批上传分析
3. **错误恢复**: 遇到错误时使用"重新开始分析"功能
4. **格式检查**: 确保CSV文件包含必需的字段

## 故障处理步骤

### 如果分析失败：
1. 点击"重新开始分析"按钮
2. 检查文件格式是否正确
3. 尝试刷新页面重新上传
4. 查看控制台错误信息

### 如果下载失败：
1. 确认分析已完成（状态为"Analysis Completed"）
2. 重新运行分析生成新的结果文件
3. 检查网络连接

## 长期改进建议

1. **数据库存储**: 使用Redis或Vercel KV进行持久化存储
2. **任务队列**: 实现后台任务处理系统
3. **文件缓存**: 将结果文件存储到云存储服务
4. **实时AI**: 集成真实的AI分析服务

---

*此文档记录了2024年修复serverless环境任务丢失问题的完整解决方案* 